<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è¿è¥åé¦ˆ</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #6366f1; --primary-soft: #eef2ff; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --text-sub: #64748b; --danger: #ef4444; --border: #f1f5f9; }
    * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 40px 20px; display: flex; justify-content: center; }

    #auth-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; }
    .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 45px; height: 45px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .container { width: 100%; max-width: 800px; animation: slideUp 0.5s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .glass-card { background: var(--card); border-radius: 32px; padding: 35px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); border: 1px solid #fff; }

    .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 13px; font-weight: 700; color: var(--text-sub); }
    .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #10b981; box-shadow: 0 0 10px #10b981; }

    .view { display: none; } .view.active { display: block; }

    /* Menu Item Styles */
    .menu-item { background: #fff; border: 1px solid var(--border); padding: 20px 26px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; }
    .menu-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.1); }
    .menu-content { flex: 1; cursor: pointer; display: flex; justify-content: space-between; align-items: center; margin-right: 15px; }
    .menu-actions { display: flex; gap: 8px; }
    .btn-action { background: none; border: none; cursor: pointer; padding: 5px; font-size: 16px; opacity: 0.5; }
    .btn-action:hover { opacity: 1; }

    .count-badge { background: var(--primary-soft); color: var(--primary); padding: 6px 16px; border-radius: 14px; font-weight: 800; font-size: 15px; }

    .btn-back { background: #f1f5f9; border: none; padding: 12px 20px; border-radius: 14px; font-weight: 700; cursor: pointer; margin-bottom: 25px; color: var(--text-sub); }
    .search-box { width: 100%; padding: 16px 20px; border-radius: 18px; border: 1px solid var(--border); background: #f8fafc; font-family: inherit; font-size: 15px; outline: none; margin-bottom: 20px; }

    .item-list-container { max-height: 450px; overflow-y: auto; padding-right: 8px; }
    .item-row { display: flex; align-items: center; gap: 16px; padding: 20px; background: #fff; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 12px; }
    .item-info { flex: 1; }
    .item-name { font-weight: 600; font-size: 16px; }
    .counter-box { display: flex; align-items: center; background: #f8fafc; padding: 6px; border-radius: 16px; gap: 12px; }
    .btn-ctrl { width: 38px; height: 38px; border-radius: 12px; border: none; font-size: 22px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .btn-minus { background: #fee2e2; color: var(--danger); }
    .btn-plus { background: var(--primary); color: white; }
    .val-display { font-weight: 800; min-width: 32px; text-align: center; font-size: 19px; }

    .bulk-area { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 20px; margin-top: 30px; }
    .add-cat-area { margin-bottom: 25px; display: flex; gap: 10px; }
    .input-minimal { flex: 1; padding: 14px 20px; border-radius: 16px; border: 1px solid var(--border); outline: none; }
    .btn-add-cat { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 16px; font-weight: 600; cursor: pointer; }

    textarea { width: 100%; border: none; background: transparent; min-height: 90px; outline: none; font-family: inherit; font-size: 15px; resize: none; }

    .btn-confirm { width: 100%; background: var(--text); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 12px; }

    .footer-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; margin-top: 35px; border-top: 1px solid var(--border); padding-top: 25px; }
    .btn-footer { padding: 18px; border-radius: 18px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; }
    .btn-reset { background: #fff; border: 2px solid #fee2e2; color: var(--danger); }
    .btn-export { background: var(--primary); color: white; box-shadow: 0 12px 24px -6px rgba(99, 102, 241, 0.4); }

    .ip-box { background:#f1f5f9; padding:15px; border-radius:12px; font-family:monospace; font-weight:800; color:#1e293b; font-size:18px; margin: 10px 0; border: 1px solid var(--border); }
  </style>
</head>

<body>
  <div id="auth-overlay">
    <div class="loader"></div>
    <p id="auth-msg" style="font-weight:700; color:#64748b;">ğŸ” æ­£åœ¨éªŒè¯èº«ä»½...</p>
  </div>

  <div class="container">
    <div class="status-bar">
      <div><span class="dot"></span> <span id="sync-label">åœ¨çº¿</span></div>
      <div id="date-label"></div>
    </div>

    <div class="glass-card">
      <div id="home-view" class="view active">
        <h1 style="margin:0 0 10px 0; font-weight:800; font-size:32px; letter-spacing:-1px;">ZH è¿è¥é—®é¢˜åé¦ˆ</h1>

        <div class="add-cat-area">
          <input type="text" id="new-cat-input" class="input-minimal" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°...">
          <button class="btn-add-cat" onclick="addCategory()">+ æ·»åŠ </button>
        </div>

        <div id="menu-list"></div>

        <div class="footer-grid">
          <button class="btn-footer btn-reset" onclick="resetAll()">å…¨éƒ¨æ¸…é›¶</button>
          <button class="btn-footer btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡º</button>
        </div>
      </div>

      <div id="detail-view" class="view">
        <button class="btn-back" onclick="showHome()">â† è¿”å›ä¸»é¡µ</button>
        <h2 id="detail-title" style="margin-bottom:22px; font-weight:800; font-size:24px;"></h2>
        <input type="text" id="search-box" class="search-box" placeholder="ğŸ” æœç´¢ " oninput="searchItems()">
        <div class="item-list-container" id="item-list"></div>

        <div class="bulk-area">
          <div style="font-size:13px; color:var(--text-sub); font-weight:800; margin-bottom:10px;">
            æ‰¹é‡æ·»åŠ é¡¹ç›®ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
          </div>
          <textarea id="bulk-input" placeholder="è¯·ç²˜è´´é¡¹ç›®åˆ—è¡¨..."></textarea>
          <button class="btn-confirm" onclick="processBulk()">ç¡®è®¤æ·»åŠ é¡¹ç›®</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // âœ… YOUR WEB APP URL
  const API_URL = "https://script.google.com/macros/s/AKfycbyGxPCvLsCPa6iC0J845r5LHDTJXVOSsXclNTsg1-pkvOUn7jlGMGiCRXfjHa5sJ-PD/exec";

  let state = [];
  let activeIdx = null;
  let debounceTimer = null;

  // realtime
  let lastUpdatedAt = 0;
  let isSaving = false;
  const POLL_MS = 1000;

  const d = new Date();
  document.getElementById('date-label').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;

  // -------- Cloud Helpers --------
  async function fetchCloud() {
    const res = await fetch(API_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("GET failed: " + res.status);
    return await res.json();
  }

  function applyCloud(cloudRes) {
    // expect: { allowedIPs, updatedAt, db }
    if (!cloudRes) return;
    if (!Array.isArray(cloudRes.db)) return;

    const cloudUpdatedAt = Number(cloudRes.updatedAt || 0);
    if (cloudUpdatedAt && cloudUpdatedAt <= lastUpdatedAt) return;

    state = cloudRes.db.length ? cloudRes.db : [
      { title: "1. èµ„é‡‘ä¸åŒæ­¥", items: [] },
      { title: "2. ä¼šå‘˜åé¦ˆå¼‚å¸¸", items: [] }
    ];

    lastUpdatedAt = cloudUpdatedAt || Date.now();

    if (activeIdx === null) renderHome();
    else renderDetail();

    document.getElementById('sync-label').innerText = "ğŸ”„ å·²æ›´æ–°";
  }

  function startPolling() {
    setInterval(async () => {
      if (isSaving) return;
      try {
        const cloudRes = await fetchCloud();
        applyCloud(cloudRes);
      } catch (e) {
        // ignore polling errors
      }
    }, POLL_MS);
  }

  async function init() {
    try {
      const [ipRes, cloudRes] = await Promise.all([
        fetch('https://api.ipify.org?format=json').then(r => r.json()),
        fetchCloud()
      ]);

      const userIP = (ipRes.ip || "").trim();
      const allowedList = cloudRes.allowedIPs || [];

      if (!allowedList.includes(userIP)) {
        document.getElementById('auth-overlay').style.background = "#fff";
        document.getElementById('auth-msg').innerHTML = `
          <h1 style="color:var(--danger); margin:0; font-size:24px;">â›” è®¿é—®è¢«æ‹’ç»</h1>
          <p style="color:var(--text-sub); margin:15px 0;">æ‚¨çš„ IP ä¸åœ¨å…è®¸åˆ—è¡¨ä¸­</p>
          <div class="ip-box">${userIP}</div>
          <button onclick="location.reload()" style="margin-top:15px; padding:10px 20px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700;">ğŸ”„ åˆ·æ–°é¡µé¢</button>
        `;
        document.querySelector('.loader').style.display = 'none';
        return;
      }

      // init state
      state = (Array.isArray(cloudRes.db) && cloudRes.db.length) ? cloudRes.db : [
        { title: "1. èµ„é‡‘ä¸åŒæ­¥", items: [] },
        { title: "2. ä¼šå‘˜åé¦ˆå¼‚å¸¸", items: [] }
      ];
      lastUpdatedAt = Number(cloudRes.updatedAt || Date.now());

      document.getElementById('auth-overlay').style.display = 'none';
      renderHome();
      startPolling();

    } catch (e) {
      document.getElementById('auth-msg').innerText = "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥";
    }
  }

  function syncCloud() {
    document.getElementById('sync-label').innerText = "â³ æ­£åœ¨ä¿å­˜...";
    if (debounceTimer) clearTimeout(debounceTimer);

    debounceTimer = setTimeout(async () => {
      isSaving = true;
      try {
        const payload = { updatedAt: Date.now(), db: state };

        // âœ… IMPORTANT: NO headers -> avoid CORS preflight on GAS
        const res = await fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        if (!res.ok) throw new Error("POST failed: " + res.status);

        lastUpdatedAt = payload.updatedAt;
        document.getElementById('sync-label').innerText = "âœ… å·²åŒæ­¥";
      } catch (e) {
        document.getElementById('sync-label').innerText = "âŒ åŒæ­¥å¤±è´¥";
        console.log("sync error:", e);
      } finally {
        isSaving = false;
      }
    }, 500);
  }

  // -------- CATEGORY ACTIONS --------
  function addCategory() {
    const input = document.getElementById('new-cat-input');
    const title = input.value.trim();
    if (title) {
      state.push({ title: title, items: [] });
      input.value = '';
      renderHome();
      syncCloud();
    }
  }

  function editCategory(i, event) {
    event.stopPropagation();
    const newTitle = prompt("ä¿®æ”¹åˆ†ç±»åç§°:", state[i].title);
    if (newTitle && newTitle.trim() !== "") {
      state[i].title = newTitle.trim();
      renderHome();
      syncCloud();
    }
  }

  function deleteCategory(i, event) {
    event.stopPropagation();
    if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±» "${state[i].title}" åŠå…¶æ‰€æœ‰æ•°æ®å—ï¼Ÿ`)) {
      state.splice(i, 1);
      if (activeIdx !== null && activeIdx >= state.length) activeIdx = null;
      renderHome();
      syncCloud();
    }
  }

  function renderHome() {
    const list = document.getElementById('menu-list');
    list.innerHTML = '';
    state.forEach((cat, i) => {
      const total = (cat.items || []).reduce((s, item) => s + (Number(item.count) || 0), 0);
      const div = document.createElement('div');
      div.className = 'menu-item';
      div.innerHTML = `
        <div class="menu-content" onclick="showDetail(${i})">
          <span style="font-weight:600">${escapeHtml(cat.title)}</span>
          <span class="count-badge">${total}</span>
        </div>
        <div class="menu-actions">
          <button class="btn-action" onclick="editCategory(${i}, event)" title="ç¼–è¾‘">âœï¸</button>
          <button class="btn-action" onclick="deleteCategory(${i}, event)" title="åˆ é™¤">ğŸ—‘ï¸</button>
        </div>
      `;
      list.appendChild(div);
    });
  }

  function showDetail(i) {
    activeIdx = i;
    document.getElementById('home-view').classList.remove('active');
    document.getElementById('detail-view').classList.add('active');
    document.getElementById('search-box').value = '';
    renderDetail();
  }

  function showHome() {
    activeIdx = null;
    document.getElementById('detail-view').classList.remove('active');
    document.getElementById('home-view').classList.add('active');
    renderHome();
  }

  function renderDetail() {
    if (activeIdx === null) return;
    const list = document.getElementById('item-list');
    list.innerHTML = '';
    document.getElementById('detail-title').innerText = state[activeIdx].title;

    (state[activeIdx].items || []).forEach((item, i) => {
      const row = document.createElement('div');
      row.className = 'item-row';
      row.setAttribute('data-name', item.name || "");
      row.innerHTML = `
        <div class="item-info">
          <div class="item-name">${escapeHtml(item.name || "")}</div>
          <div style="font-size:12px; color:var(--text-sub); margin-top:5px;">
            <span style="cursor:pointer" onclick="editItem(${i})">âœï¸ ç¼–è¾‘</span> |
            <span style="cursor:pointer; color:var(--danger)" onclick="deleteItem(${i})">ğŸ—‘ï¸ åˆ é™¤</span>
          </div>
        </div>
        <div class="counter-box">
          <button class="btn-ctrl btn-minus" onclick="changeCount(${i},-1)">-</button>
          <span class="val-display">${Number(item.count) || 0}</span>
          <button class="btn-ctrl btn-plus" onclick="changeCount(${i},1)">+</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  // -------- ITEM ACTIONS --------
  function changeCount(i, v) {
    const it = state[activeIdx].items[i];
    const next = (Number(it.count) || 0) + v;
    if (next >= 0) {
      it.count = next;
      renderDetail();
      syncCloud();
    }
  }

  function processBulk() {
    const input = document.getElementById('bulk-input');
    const lines = input.value.split('\n');

    lines.forEach(line => {
      const name = line.trim();
      if (!name) return;
      if (!state[activeIdx].items.some(x => x.name === name)) {
        state[activeIdx].items.push({ name: name, count: 0 });
      }
    });

    input.value = '';
    renderDetail();
    syncCloud();
  }

  function editItem(i) {
    const n = prompt("ä¿®æ”¹é¡¹ç›®åç§°:", state[activeIdx].items[i].name);
    if (n && n.trim() !== "") {
      state[activeIdx].items[i].name = n.trim();
      renderDetail();
      syncCloud();
    }
  }

  function deleteItem(i) {
    if (confirm("ç¡®å®šåˆ é™¤è¯¥é¡¹ç›®?")) {
      state[activeIdx].items.splice(i, 1);
      renderDetail();
      syncCloud();
    }
  }

  function resetAll() {
    if (confirm("âš ï¸ ç¡®å®šè¦æ¸…é›¶æ‰€æœ‰é¡¹ç›®çš„æ•°å€¼å—ï¼Ÿ(åˆ†ç±»å’Œé¡¹ç›®åå°†ä¿ç•™)")) {
      state.forEach(c => (c.items || []).forEach(i => i.count = 0));
      renderHome();
      syncCloud();
    }
  }

  function searchItems() {
    const k = document.getElementById('search-box').value.toLowerCase();
    document.querySelectorAll('.item-row').forEach(r => {
      const name = (r.getAttribute('data-name') || "").toLowerCase();
      r.style.display = name.includes(k) ? 'flex' : 'none';
    });
  }

  function exportData() {
    let d = [];
    state.forEach(c => (c.items || []).forEach(i => {
      const count = Number(i.count) || 0;
      if (count > 0) d.push({ "åˆ†ç±»": c.title, "é¡¹ç›®": i.name, "æ•°é‡": count });
    }));
    if (d.length === 0) return alert("æ— å¯å¯¼å‡ºæ•°æ®");

    const ws = XLSX.utils.json_to_sheet(d);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Data");

    const now = new Date();
    const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
    XLSX.writeFile(wb, `è¿è¥é—®é¢˜ç»Ÿè®¡_${dateStr}.xlsx`);
  }

  // -------- Small helper --------
  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  init();
</script>
</body>
</html>
