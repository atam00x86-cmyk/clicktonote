<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¥åé¦ˆ </title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script>
        // --- ğŸ›‘ Cáº¤U HÃŒNH ---
        const ALLOWED_IPS = ['180.232.127.105', '8.217.98.79', '8.217.80.232','47.243.144.45','8.217.113.241','47.242.153.20','47.242.218.225','8.217.236.240','47.76.45.131','47.238.169.215','47.76.154.120','47.76.149.103','8.210.112.35','8.217.83.139','8.217.236.240','47.76.45.131','47.76.45.131','8.210.2.84','47.76.72.160','47.238.182.165','8.217.98.79','8.217.124.204','47.76.126.89','47.239.94.27','47.239.98.226','47.239.238.0','47.239.98.0','47.239.98.34','47.239.97.197','8.218.115.89','47.239.96.168','47.239.98.246','47.239.94.59','47.83.12.161','47.239.97.144','47.239.97.11','47.239.98.100'];
        const API_URL = 'https://script.google.com/macros/s/AKfycbxurzhL5yoyMSZ7xSBAoSFCp_Pbiq-X5T7gBosFfJsZAHZFkG_8p1QGX7m3rm366_er/exec'; 

        // Kiá»ƒm tra IP
        async function checkIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json');
                const data = await res.json();
                if (!ALLOWED_IPS.includes(data.ip)) {
                    document.body.innerHTML = `<h1 style="text-align:center;margin-top:100px;">ğŸ”’ Access Denied (${data.ip})</h1>`;
                    return false;
                }
                return true;
            } catch (e) { return true; } // Bá» qua náº¿u lá»—i fetch IP
        }
    </script>

    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 800px; }
        .glass-card { background: var(--card); border-radius: 28px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 12px; font-weight: 600; }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-online { background: #10b981; box-shadow: 0 0 8px #10b981; }

        .menu-grid { display: grid; gap: 15px; }
        .menu-item { background: #fff; border: 1px solid #f1f5f9; padding: 24px; border-radius: 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .menu-item:hover { transform: translateY(-3px); border-color: var(--primary); }
        .count-badge { background: #eef2ff; color: var(--primary); padding: 6px 14px; border-radius: 12px; font-weight: 800; }

        .view { display: none; } .view.active { display: block; }
        .btn-back { background: #f1f5f9; border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 15px; border-radius: 16px; border: 1px solid #f1f5f9; margin-bottom: 20px; outline: none; }
        
        .item-row { display: flex; align-items: center; gap: 15px; padding: 18px; background: #fff; border-radius: 18px; border: 1px solid #f1f5f9; margin-bottom: 12px; }
        .counter-box { display: flex; align-items: center; background: #f8fafc; padding: 5px; border-radius: 14px; gap: 10px; }
        .btn-ctrl { width: 36px; height: 36px; border-radius: 10px; border: none; font-size: 20px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        .bulk-area { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 20px; padding: 15px; margin-top: 20px; }
        textarea { width: 100%; border: none; background: transparent; min-height: 80px; outline: none; font-family: inherit; }
        .btn-save-cloud { width: 100%; background: var(--primary); color: white; border: none; padding: 15px; border-radius: 15px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div class="status-bar">
        <div><span class="dot dot-online"></span> <span id="sync-text">å·²è¿æ¥äº‘ç«¯ </span></div>
        <div id="date-text"></div>
    </div>

    <div class="glass-card">
        <div id="home-view" class="view active">
            <h1 style="margin-top:0; font-weight:800; letter-spacing:-1px;">è¿è¥åé¦ˆç³»ç»Ÿ</h1>
            <div class="menu-grid" id="menu-list"></div>
            <div style="margin-top:30px; display:grid; grid-template-columns:1fr 2fr; gap:15px;">
                <button onclick="resetData()" style="padding:18px; border-radius:18px; border:1px solid #fee2e2; color:red; cursor:pointer; font-weight:700; background:white;">å…¨éƒ¨æ¸…é›¶</button>
                <button onclick="exportExcel()" style="padding:18px; border-radius:18px; border:none; background:var(--primary); color:white; cursor:pointer; font-weight:700;">å¯¼å‡º Excel</button>
            </div>
        </div>

        <div id="detail-view" class="view">
            <button class="btn-back" onclick="showHome()">â† è¿”å›</button>
            <h2 id="detail-title" style="margin-bottom:20px; font-weight:800;"></h2>
            <input type="text" id="search-box" class="search-input" placeholder="ğŸ” æœç´¢" oninput="doSearch()">
            <div id="item-list" style="max-height:400px; overflow-y:auto;"></div>
            
            <div class="bulk-area">
                <textarea id="bulk-input" placeholder="æ·»åŠ é¡¹ç›®"></textarea>
                <button class="btn-save-cloud" onclick="addBulk()">ç¡®è®¤æ·»åŠ å¹¶åŒæ­¥</button>
            </div>
        </div>
    </div>
</div>

<script>
    let state = [];
    let curIdx = null;
    let saveTimeout = null;

    // Khá»Ÿi táº¡o ngÃ y
    const d = new Date();
    document.getElementById('date-text').innerText = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;

    // Láº¥y dá»¯ liá»‡u tá»« Cloud khi má»Ÿ web
    async function init() {
        if (!await checkIP()) return;
        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            state = data.length ? data : [
                { title: "1. èµ„é‡‘ä¸åŒæ­¥ï¼ŒååŠ©å›æ”¶", items: [] },
                { title: "2. ä¼šå‘˜åé¦ˆèµ„é‡‘æ‰å¤±/è½¬ç§»å¼‚å¸¸", items: [] },
                { title: "3. æ³¨å•ç»“ç®—é”™è¯¯", items: [] },
                { title: "4. æ³¨å•æœªç»“ç®—é—®é¢˜", items: [] }
            ];
            renderHome();
        } catch (e) {
            document.getElementById('sync-text').innerText = "â˜ï¸ ç¦»çº¿æ¨¡å¼ (Cháº¿ Ä‘á»™ ngoáº¡i tuyáº¿n)";
        }
    }

    // Tá»± Ä‘á»™ng lÆ°u lÃªn Cloud (Debounce)
    function autoSave() {
        document.getElementById('sync-text').innerText = "â³ æ­£åœ¨åŒæ­¥";
        if (saveTimeout) clearTimeout(saveTimeout);
        saveTimeout = setTimeout(async () => {
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(state) });
                document.getElementById('sync-text').innerText = "âœ…å·²åŒæ­¥äº‘ç«¯ ";
            } catch (e) {
                document.getElementById('sync-text').innerText = "âŒåŒæ­¥å¤±è´¥";
            }
        }, 1000);
    }

    function renderHome() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '';
        state.forEach((cat, i) => {
            const total = cat.items.reduce((s, item) => s + item.count, 0);
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.innerHTML = `<span>${cat.title}</span><span class="count-badge">${total}</span>`;
            div.onclick = () => showDetail(i);
            list.appendChild(div);
        });
    }

    function showDetail(i) {
        curIdx = i;
        document.getElementById('home-view').classList.remove('active');
        document.getElementById('detail-view').classList.add('active');
        renderDetail();
    }

    function showHome() {
        document.getElementById('detail-view').classList.remove('active');
        document.getElementById('home-view').classList.add('active');
        renderHome();
    }

    function renderDetail() {
        const list = document.getElementById('item-list');
        list.innerHTML = '';
        state[curIdx].items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'item-row'; row.setAttribute('data-name', item.name);
            row.innerHTML = `
                <div style="flex:1">
                    <div style="font-weight:600">${item.name}</div>
                    <div style="font-size:11px;color:#94a3b8;cursor:pointer" onclick="deleteItem(${i})">åˆ é™¤</div>
                </div>
                <div class="counter-box">
                    <button class="btn-ctrl" style="background:#fee2e2;color:red" onclick="changeCount(${i},-1)">-</button>
                    <span style="font-weight:800;min-width:25px;text-align:center">${item.count}</span>
                    <button class="btn-ctrl" style="background:#6366f1;color:white" onclick="changeCount(${i},1)">+</button>
                </div>`;
            list.appendChild(row);
        });
        document.getElementById('detail-title').innerText = state[curIdx].title;
    }

    function changeCount(i, v) {
        if (state[curIdx].items[i].count + v >= 0) {
            state[curIdx].items[i].count += v;
            renderDetail();
            autoSave();
        }
    }

    function addBulk() {
        const input = document.getElementById('bulk-input');
        input.value.split('\n').forEach(line => {
            if (line.trim()) state[curIdx].items.push({ name: line.trim(), count: 0 });
        });
        input.value = ''; renderDetail(); autoSave();
    }

    function deleteItem(i) { if(confirm("ç¡®å®šåˆ é™¤?")) { state[curIdx].items.splice(i,1); renderDetail(); autoSave(); } }

    function resetData() { if(confirm("å…¨éƒ¨æ¸…é›¶?")) { state.forEach(c => c.items.forEach(i => i.count=0)); renderHome(); autoSave(); } }

    function doSearch() {
        const k = document.getElementById('search-box').value.toLowerCase();
        document.querySelectorAll('.item-row').forEach(r => r.style.display = r.getAttribute('data-name').toLowerCase().includes(k) ? 'flex' : 'none');
    }

    function exportExcel() {
        let d = [];
        state.forEach(c => c.items.forEach(i => { if(i.count > 0) d.push({"åˆ†ç±»": c.title, "é¡¹ç›®": i.name, "æ•°é‡": i.count}) }));
        const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data");
        const now = new Date();
        XLSX.writeFile(wb, `è¿è¥ç»Ÿè®¡_${now.getFullYear()}${now.getMonth()+1}${now.getDate()}.xlsx`);
    }

    init();
</script>
</body>
</html>
