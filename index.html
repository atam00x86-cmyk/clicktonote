<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¥åé¦ˆ Realtime Pro</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-soft: #eef2ff;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-sub: #64748b;
            --danger: #ef4444;
            --border: #f1f5f9;
        }

        * { box-sizing: border-box; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 40px 20px;
            display: flex; justify-content: center;
        }

        /* Authentication Overlay */
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f8fafc; z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary);
            border-radius: 50%; width: 45px; height: 45px;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container { width: 100%; max-width: 800px; animation: slideUp 0.5s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .glass-card {
            background: var(--card);
            border-radius: 32px;
            padding: 35px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            border: 1px solid #fff;
        }

        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 13px; font-weight: 700; color: var(--text-sub); }
        .dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; background: #10b981; box-shadow: 0 0 10px #10b981; }

        /* Menu View */
        .view { display: none; }
        .view.active { display: block; }
        .menu-item {
            background: #fff; border: 1px solid var(--border);
            padding: 26px; border-radius: 24px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;
        }
        .menu-item:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 15px 30px -10px rgba(99, 102, 241, 0.2); }
        .count-badge { background: var(--primary-soft); color: var(--primary); padding: 6px 16px; border-radius: 14px; font-weight: 800; font-size: 15px; }

        /* Detail View */
        .btn-back { background: #f1f5f9; border: none; padding: 12px 20px; border-radius: 14px; font-weight: 700; cursor: pointer; margin-bottom: 25px; color: var(--text-sub); }
        .btn-back:hover { background: #e2e8f0; color: var(--text); }

        .search-box {
            width: 100%; padding: 16px 20px; border-radius: 18px;
            border: 1px solid var(--border); background: #f8fafc;
            font-family: inherit; font-size: 15px; outline: none; margin-bottom: 20px;
        }
        .search-box:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }

        .item-list-container { max-height: 450px; overflow-y: auto; padding-right: 8px; }
        .item-row { display: flex; align-items: center; gap: 16px; padding: 20px; background: #fff; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 12px; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }

        /* Counter box */
        .counter-box { display: flex; align-items: center; background: #f8fafc; padding: 6px; border-radius: 16px; gap: 12px; }
        .btn-ctrl { width: 38px; height: 38px; border-radius: 12px; border: none; font-size: 22px; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-minus { background: #fee2e2; color: var(--danger); }
        .btn-plus { background: var(--primary); color: white; }
        .val-display { font-weight: 800; min-width: 32px; text-align: center; font-size: 19px; }

        /* Bulk Area */
        .bulk-area { background: #f8fafc; border: 2px dashed #e2e8f0; border-radius: 24px; padding: 20px; margin-top: 30px; }
        textarea { width: 100%; border: none; background: transparent; min-height: 90px; outline: none; font-family: inherit; font-size: 15px; resize: none; }
        .btn-confirm { width: 100%; background: var(--text); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 12px; }

        /* Footer */
        .footer-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; margin-top: 35px; border-top: 1px solid var(--border); padding-top: 25px; }
        .btn-footer { padding: 18px; border-radius: 18px; border: none; font-weight: 700; cursor: pointer; font-size: 16px; }
        .btn-reset { background: #fff; border: 2px solid #fee2e2; color: var(--danger); }
        .btn-export { background: var(--primary); color: white; box-shadow: 0 12px 24px -6px rgba(99, 102, 241, 0.4); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="loader"></div>
    <p id="auth-msg" style="font-weight:700; color:#64748b;">ğŸ” æ­£åœ¨å®‰å…¨æ£€æŸ¥ä¸åŒæ­¥...</p>
</div>

<div class="container">
    <div class="status-bar">
        <div><span class="dot"></span> <span id="sync-label">äº‘ç«¯å·²å°±ç»ª</span></div>
        <div id="date-label"></div>
    </div>

    <div class="glass-card">
        <div id="home-view" class="view active">
            <h1 style="margin:0 0 35px 0; font-weight:800; font-size:32px; letter-spacing:-1px;">è¿è¥åé¦ˆç³»ç»Ÿ</h1>
            <div id="menu-list"></div>
            <div class="footer-grid">
                <button class="btn-footer btn-reset" onclick="resetAll()">å…¨éƒ¨æ¸…é›¶</button>
                <button class="btn-footer btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡º</button>
            </div>
        </div>

        <div id="detail-view" class="view">
            <button class="btn-back" onclick="showHome()">â† è¿”å›ä¸»é¡µ</button>
            <h2 id="detail-title" style="margin-bottom:22px; font-weight:800; font-size:24px;"></h2>
            <input type="text" id="search-box" class="search-box" placeholder="ğŸ” æœç´¢" oninput="searchItems()">
            <div class="item-list-container" id="item-list"></div>
            
            <div class="bulk-area">
                <div style="font-size:13px; color:var(--text-sub); font-weight:800; margin-bottom:10px;">
                <textarea id="bulk-input" placeholder="åœ¨æ­¤ç²˜è´´é¡¹ç›®åˆ—è¡¨..."></textarea>
                <button class="btn-confirm" onclick="processBulk()">ç¡®è®¤æ·»åŠ å¹¶ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ğŸ›‘ THAY Báº°NG WEB APP URL Cá»¦A Báº N ---
    const API_URL = 'https://script.google.com/macros/s/AKfycbxvSeVLQaml82DBv_g0UqSN95ft2ewdtnNpIXm6_HDcLOI1nmphUa3VktwyeYd5BuaV/exec'; 

    let state = [];
    let activeIdx = null;
    let debounceTimer = null;

    const d = new Date();
    document.getElementById('date-label').innerText = `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;

    // 1. KHá»I Táº O & KIá»‚M TRA IP
    async function init() {
        try {
            const [ipRes, cloudRes] = await Promise.all([
                fetch('https://api.ipify.org?format=json').then(r => r.json()),
                fetch(API_URL).then(r => r.json())
            ]);

            if (!cloudRes.allowedIPs.includes(ipRes.ip)) {
                document.getElementById('auth-msg').innerHTML = `<b style="color:red; font-size:20px;">Access Denied</b><br>IP: ${ipRes.ip}<br>æ‚¨çš„IPæœªæˆæƒ`;
                document.querySelector('.loader').style.display = 'none';
                return;
            }

            state = cloudRes.db.length ? cloudRes.db : [
                { title: "1. èµ„é‡‘ä¸åŒæ­¥ï¼ŒååŠ©å›æ”¶", items: [] },
                { title: "2. ä¼šå‘˜åé¦ˆèµ„é‡‘æ‰å¤±/è½¬ç§»å¼‚å¸¸", items: [] },
                { title: "3. æ³¨å•ç»“ç®—é”™è¯¯", items: [] },
                { title: "4. æ³¨å•æœªç»“ç®—é—®é¢˜", items: [] }
            ];
            
            document.getElementById('auth-overlay').style.display = 'none';
            renderHome();
        } catch (e) {
            document.getElementById('auth-msg').innerText = "âŒ æ— æ³•è¿æ¥åˆ°äº‘ç«¯æ•°æ®åº“";
        }
    }

    // 2. Äá»’NG Bá»˜ CLOUD (DEBOUNCE)
    function syncCloud() {
        document.getElementById('sync-label').innerText = "â³ æ­£åœ¨ä¿å­˜...";
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            try {
                await fetch(API_URL, { method: 'POST', body: JSON.stringify(state) });
                document.getElementById('sync-label').innerText = "âœ… äº‘ç«¯å·²åŒæ­¥";
            } catch (e) {
                document.getElementById('sync-label').innerText = "âŒ åŒæ­¥å¤±è´¥";
            }
        }, 1000);
    }

    // 3. UI LOGIC
    function renderHome() {
        const list = document.getElementById('menu-list');
        list.innerHTML = '';
        state.forEach((cat, i) => {
            const total = cat.items.reduce((s, item) => s + item.count, 0);
            const div = document.createElement('div');
            div.className = 'menu-item';
            div.innerHTML = `<span>${cat.title}</span><span class="count-badge">${total}</span>`;
            div.onclick = () => showDetail(i);
            list.appendChild(div);
        });
    }

    function showDetail(i) {
        activeIdx = i;
        document.getElementById('home-view').classList.remove('active');
        document.getElementById('detail-view').classList.add('active');
        document.getElementById('search-box').value = '';
        renderDetail();
    }

    function showHome() {
        document.getElementById('detail-view').classList.remove('active');
        document.getElementById('home-view').classList.add('active');
        renderHome();
    }

    function renderDetail() {
        const list = document.getElementById('item-list');
        list.innerHTML = '';
        state[activeIdx].items.forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'item-row'; row.setAttribute('data-name', item.name);
            row.innerHTML = `
                <div class="item-info">
                    <div class="item-name">${item.name}</div>
                    <div style="font-size:12px; color:var(--text-sub); margin-top:5px;">
                        <span style="cursor:pointer" onclick="editItem(${i})">âœï¸ ç¼–è¾‘</span> | 
                        <span style="cursor:pointer" onclick="deleteItem(${i})">ğŸ—‘ï¸ åˆ é™¤</span>
                    </div>
                </div>
                <div class="counter-box">
                    <button class="btn-ctrl btn-minus" onclick="changeCount(${i},-1)">-</button>
                    <span class="val-display">${item.count}</span>
                    <button class="btn-ctrl btn-plus" onclick="changeCount(${i},1)">+</button>
                </div>`;
            list.appendChild(row);
        });
        document.getElementById('detail-title').innerText = state[activeIdx].title;
    }

    function changeCount(i, v) {
        if (state[activeIdx].items[i].count + v >= 0) {
            state[activeIdx].items[i].count += v;
            renderDetail(); syncCloud();
        }
    }

    function processBulk() {
        const input = document.getElementById('bulk-input');
        const lines = input.value.split('\n');
        lines.forEach(line => {
            const name = line.trim();
            if (name && !state[activeIdx].items.some(x => x.name === name)) {
                state[activeIdx].items.push({ name: name, count: 0 });
            }
        });
        input.value = ''; renderDetail(); syncCloud();
    }

    function editItem(i) {
        const n = prompt("ä¿®æ”¹åç§°:", state[activeIdx].items[i].name);
        if(n) { state[activeIdx].items[i].name = n; renderDetail(); syncCloud(); }
    }

    function deleteItem(i) {
        if(confirm("ç¡®å®šè¦åˆ é™¤æ­¤é¡¹ç›®å—?")) { state[activeIdx].items.splice(i,1); renderDetail(); syncCloud(); }
    }

    function resetAll() {
        if(confirm("âš ï¸ æ˜¯å¦æ¸…ç©ºæ‰€æœ‰åˆ†ç±»ä¸‹çš„ç»Ÿè®¡æ•°æ®ï¼Ÿ")) {
            state.forEach(c => c.items.forEach(i => i.count = 0));
            renderHome(); syncCloud();
        }
    }

    function searchItems() {
        const k = document.getElementById('search-box').value.toLowerCase();
        document.querySelectorAll('.item-row').forEach(r => {
            const name = r.getAttribute('data-name').toLowerCase();
            r.style.display = name.includes(k) ? 'flex' : 'none';
        });
    }

    function exportData() {
        let d = [];
        state.forEach(c => c.items.forEach(i => {
            if(i.count > 0) d.push({"åé¦ˆåˆ†ç±»": c.title, "å…·ä½“é¡¹ç›®": i.name, "ç»Ÿè®¡æ•°é‡": i.count});
        }));
        if(d.length === 0) return alert("æ— å¯å¯¼å‡ºçš„æœ‰æ•ˆæ•°æ®");
        const ws = XLSX.utils.json_to_sheet(d);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ç»Ÿè®¡æ•°æ®");
        const now = new Date();
        const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
        XLSX.writeFile(wb, `è¿è¥é—®é¢˜ç»Ÿè®¡_${dateStr}.xlsx`);
    }

    init();
</script>
</body>
</html>
